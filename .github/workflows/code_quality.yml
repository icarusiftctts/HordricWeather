name: ðŸ“ˆ Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Tous les lundis Ã  9h UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: ðŸŽ¯ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: 'stable'
          cache: true
      
      - name: ðŸ“¦ Get dependencies
        run: flutter pub get
      
      - name: ðŸ“ Count lines of code
        run: |
          echo "ðŸ“Š Lines of Code Statistics:"
          echo "----------------------------"
          find lib -name "*.dart" | xargs wc -l | tail -1
          echo ""
          echo "ðŸ“ Files by directory:"
          find lib -name "*.dart" -type f | cut -d/ -f1-3 | sort | uniq -c
      
      - name: ðŸ” Check code complexity
        run: |
          echo "ðŸ§® Code Complexity Check:"
          flutter pub global activate dart_code_metrics
          flutter pub global run dart_code_metrics:metrics analyze lib --reporter=console
        continue-on-error: true
      
      - name: ðŸ”’ Security audit
        run: |
          echo "ðŸ”’ Security Audit:"
          echo "Checking for known vulnerabilities in dependencies..."
          flutter pub outdated --json > outdated.json || true
          cat outdated.json
        continue-on-error: true
      
      - name: ðŸ“¦ Dependency analysis
        run: |
          echo "ðŸ“¦ Dependency Tree:"
          flutter pub deps --style=compact
      
      - name: ðŸŽ¯ Unused code detection
        run: |
          echo "ðŸŽ¯ Checking for unused imports and code..."
          flutter analyze --no-fatal-infos | grep -i "unused" || echo "No unused code detected"
        continue-on-error: true
      
      - name: âœ… Quality Summary
        if: success()
        run: |
          echo "âœ… Code quality checks completed!"
          echo "Review the logs above for detailed metrics."
